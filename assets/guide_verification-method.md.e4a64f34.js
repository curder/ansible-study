import{_ as s,c as a,o as n,O as l}from"./chunks/framework.e51d172d.js";const A=JSON.parse('{"title":"认证方式","description":"","frontmatter":{},"headers":[],"relativePath":"guide/verification-method.md","lastUpdated":1677337208000}'),o={name:"guide/verification-method.md"},p=l(`<h1 id="认证方式" tabindex="-1">认证方式 <a class="header-anchor" href="#认证方式" aria-label="Permalink to &quot;认证方式&quot;">​</a></h1><p>安全认证分为两种：</p><ul><li>第一种是：密码认证，但是密码是明文配置在主机清单配置文件中，考虑到安全性问题。<strong>不推荐使用</strong></li><li>第二种是：SSH Key 秘钥对验证，安全性相对明文来说较高。<strong>推荐使用</strong></li></ul><p>不管是密码认证还是SSH Key 密钥对验证方式，建议在控制节点服务器上通过 SSH 命令连接一次，检查是否能正确连通。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">ssh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">server_username@host</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 输入命令后回车输入服务器密码</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">ssh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">server_username@host</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.ssh/id_rsa</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 输入命令后回车连接到服务器</span></span></code></pre></div><details class="details custom-block"><summary>连接指纹确认注意事项</summary><p>第一次在控制节点服务器连接到被控制的服务器时都会提示是否需要进行指纹确认，输入 <code>y</code> 确认即可。</p><p>这样的话连接的指纹信息被计入到了控制节点服务器的 <code>~/.ssh/known_hosts</code> 文件中。</p><p>如果不想将指纹信息记录到 <code>~/.ssh/known_hosts</code> 文件中，可以在 ansible 的默认的配置文件 <code>/etc/ansible/ansible.cfg</code> 中进行配置：</p><div class="language-ini"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">host_key_checking</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> False</span></span></code></pre></div><p>这样配置好之后下次再使用 ansible 连接服务器时就不会记录指纹信息到 <code>~/.ssh/known_hosts</code> 文件中。</p></details><h2 id="密码认证" tabindex="-1">密码认证 <a class="header-anchor" href="#密码认证" aria-label="Permalink to &quot;密码认证&quot;">​</a></h2><table><thead><tr><th>参数</th><th>参数类型</th><th>参数说明</th></tr></thead><tbody><tr><td><code>ansible_host</code></td><td>主机地址</td><td>被管理服务器的IP地址</td></tr><tr><td><code>ansible_port</code></td><td>主机端口</td><td>被管理服务器开放的SSH端口</td></tr><tr><td><code>ansible_user</code></td><td>主机用户</td><td>被管理服务器SSH用户</td></tr><tr><td><code>ansible_password</code></td><td>主机密码</td><td>被管理服务器SSH用户对应的密码</td></tr></tbody></table><p>更多 ansible 连接参数参考<a href="https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#connecting-to-hosts-behavioral-inventory-parameters" target="_blank" rel="noreferrer">官方地址</a>。</p><p>比如在主机清单中添加以上配置：</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-1ljFk" id="tab-8_w2Zc1" checked="checked"><label for="tab-8_w2Zc1">ini</label><input type="radio" name="group-1ljFk" id="tab-mbsko4S"><label for="tab-mbsko4S">yaml</label></div><div class="blocks"><div class="language-ini active"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">[web]</span></span>
<span class="line"><span style="color:#A6ACCD;">centos </span><span style="color:#F07178;">ansible_host</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">10.211.55.4 </span><span style="color:#F07178;">ansible_user</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">root </span><span style="color:#F07178;">ansible_password</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">a </span><span style="color:#F07178;">ansible_port</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">22</span></span>
<span class="line"><span style="color:#A6ACCD;">ubuntu </span><span style="color:#F07178;">ansible_host</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">10.211.55.5 </span><span style="color:#F07178;">ansible_user</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">root </span><span style="color:#F07178;">ansible_password</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">a </span><span style="color:#F07178;">ansible_port</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">22</span></span></code></pre></div><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">web</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">hosts</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">centos</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ansible_host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10.211.55.4</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ansible_user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ansible_password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ansible_port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">22</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ubuntu</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">ansible_host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10.211.55.5</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">ansible_user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">ansible_password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">ansible_port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">22</span></span></code></pre></div></div></div><details class="details custom-block"><summary>或者使用变量</summary><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-svKIi" id="tab-PCtOcMe" checked="checked"><label for="tab-PCtOcMe">ini</label><input type="radio" name="group-svKIi" id="tab-Pqf-m3m"><label for="tab-Pqf-m3m">yaml</label></div><div class="blocks"><div class="language-ini active"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">[web]</span></span>
<span class="line"><span style="color:#A6ACCD;">centos </span><span style="color:#F07178;">ansible_host</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">10.211.55.4</span></span>
<span class="line"><span style="color:#A6ACCD;">ubuntu </span><span style="color:#F07178;">ansible_host</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">10.211.55.5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">[web:vars]</span></span>
<span class="line"><span style="color:#F07178;">ansible_user</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">root</span></span>
<span class="line"><span style="color:#F07178;">ansible_password</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">a</span></span>
<span class="line"><span style="color:#F07178;">ansible_port</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">22</span></span></code></pre></div><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F07178;">web</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">hosts</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">centos</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ansible_host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10.211.55.4</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ubuntu</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#F07178;">ansible_host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10.211.55.5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">vars</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ansible_user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ansible_password</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">ansible_port</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">22</span></span></code></pre></div></div></div></details><p>使用 ansible 临时命令模式执行测试：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">ansible</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">web</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">inventory.ini</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-a</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">hostname</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#FFCB6B;">ansible</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">web</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">inventory.yml</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-a</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">hostname</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><details class="details custom-block"><summary>sshpass错误处理</summary><p>如果在执行上面的命令时，抛出 <code>to use the &#39;ssh&#39; connection type with passwords or pkcs11_provider, you must install the sshpass program</code> 的错误。</p><p>针对不同的操作系统，有不同的解决方案：</p><ul><li><p><strong>MacOS</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">brew</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://raw.githubusercontent.com/kadwanev/bigboybrew/master/Library/Formula/sshpass.rb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 如果通过上面的方式无法一条命令完成安装，可以使用下面的方式通过源代码方式安装</span></span>
<span class="line"><span style="color:#FFCB6B;">wget</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://sourceforge.net/projects/sshpass/files/latest/download/sshpass/</span><span style="color:#F78C6C;">1.10</span><span style="color:#C3E88D;">/sshpass-1.10.tar.gz</span></span>
<span class="line"><span style="color:#FFCB6B;">tar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xvf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sshpass-1.10.tar.gz</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sshpass-</span><span style="color:#F78C6C;">1.10</span></span>
<span class="line"><span style="color:#82AAFF;">.</span><span style="color:#FFCB6B;">/configure</span></span>
<span class="line"><span style="color:#FFCB6B;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span></span></code></pre></div></li><li><p><strong>CentOS</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">yum</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sshpass</span></span></code></pre></div></li><li><p><strong>Ubuntu</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sshpass</span></span></code></pre></div></li></ul></details><h2 id="密钥对认证" tabindex="-1">密钥对认证 <a class="header-anchor" href="#密钥对认证" aria-label="Permalink to &quot;密钥对认证&quot;">​</a></h2><p>使用密钥对认证需要将控制节点上生成的密钥对的公钥分发到待管理的机器上。</p><p>在操作的时候，可以直接使用服务器最高权限的 <code>root</code> 用户，为了安全下面以新建一个操作用户 <code>ansible</code> 用户，密码为 <code>123456</code> 做演示。</p><h3 id="建立管理用户" tabindex="-1">建立管理用户 <a class="header-anchor" href="#建立管理用户" aria-label="Permalink to &quot;建立管理用户&quot;">​</a></h3><p><strong>以下命令需要在所有机器上执行，包括控制端服务器和被控制端服务器。</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 添加用户</span></span>
<span class="line"><span style="color:#FFCB6B;">useradd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ansible</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># CentOS</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## 将用户添加到 wheel 组并设置免密执行 sudo 命令</span></span>
<span class="line"><span style="color:#FFCB6B;">usermod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-aG</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wheel</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ansible</span></span>
<span class="line"><span style="color:#FFCB6B;">sed</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">s/# %wheel/%wheel/g</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/sudoers</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Ubuntu</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## 将用户设置免密执行 sudo 命令</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ansible  ALL=(ALL:ALL) NOPASSWD: ALL</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/sudoers</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">请注意</p><p>上面命令中没有给新建的 <code>ansible</code> 用户设置登陆的密码，那么要使用该用户登陆服务器时只能使用私钥进行授权登陆。</p></div><h3 id="生成密钥对" tabindex="-1">生成密钥对 <a class="header-anchor" href="#生成密钥对" aria-label="Permalink to &quot;生成密钥对&quot;">​</a></h3><p>在控制端服务器生成密钥对即可。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">su</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ansible</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 切换不到 ansible 用户</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">ssh-keygen</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-t</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rsa</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-f</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.ssh/id_rsa</span></span></code></pre></div><ul><li><code>-t</code> 自定义密钥对类型，默认是 <code>rsa</code></li><li><code>-f</code> 自定义密钥对存储内容和文件名，默认是 <code>~/.ssh/id_rsa</code></li></ul><p>上面的命令会生成两个文件，密钥文件 <code>~/.ssh/id_rsa</code> 和 公钥文件 <code>~/.ssh/id_rsa.pub</code>。</p><p>其中私钥文件 <code>~/.ssh/id_rsa</code> 是无论如何也不应该暴露给其他服务器或者人。</p><p>而公钥文件 <code>~/.ssh/id_rsa.pub</code> 是需要分发到被控制服务器上的。</p><h3 id="分发公钥" tabindex="-1">分发公钥 <a class="header-anchor" href="#分发公钥" aria-label="Permalink to &quot;分发公钥&quot;">​</a></h3><ol><li>在控制端服务器登陆 <code>ansible</code> 用户，拿到<strong>控制端服务器</strong>的公钥内容 <code>~/.ssh/id_rsa.pub</code></li><li>粘贴到<strong>被控制端服务器</strong>的 <code>~/.ssh/authorized_keys</code> 内（注意用户是 ansible）</li></ol><p><strong>值得注意的是：</strong> 被控制端的 <code>~/.ssh</code> 文件夹的权限是 <code>700</code>，而 <code>~/.ssh/authorized_keys</code> 文件的权限是 <code>600</code>。</p><p>以上是针对被控制端服务器的 <code>ansible</code> 用户密码没有设置的情况。</p><details class="details custom-block"><summary>给被控制端服务器的 <code>ansible</code> 用户设置密码应该怎么做？</summary><ol><li>在控制端服务器登陆 ansible</li><li>执行 <code>ssh-copy-id</code> 命令</li></ol><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 执行完下面的命令后输入密码即可</span></span>
<span class="line"><span style="color:#FFCB6B;">ssh-copy-id</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ansible@centos</span></span>
<span class="line"><span style="color:#FFCB6B;">ssh-copy-id</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ansible@ubuntu</span></span></code></pre></div></details><h3 id="验证" tabindex="-1">验证 <a class="header-anchor" href="#验证" aria-label="Permalink to &quot;验证&quot;">​</a></h3><p>通过上面一系列的配置后，使用下面的命令可以免密快速登陆到被控制服务器上。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">ssh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ansible@centos</span></span>
<span class="line"><span style="color:#FFCB6B;">ssh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ansible@ubuntu</span></span></code></pre></div>`,37),e=[p];function t(c,r,i,y,C,d){return n(),a("div",null,e)}const F=s(o,[["render",t]]);export{A as __pageData,F as default};
