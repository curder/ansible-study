import{_ as s,c as a,o as n,O as l}from"./chunks/framework.e51d172d.js";const F=JSON.parse('{"title":"playbook 剧本","description":"","frontmatter":{},"headers":[],"relativePath":"guide/playbook.md","lastUpdated":1684130169000}'),p={name:"guide/playbook.md"},o=l(`<h1 id="playbook-剧本" tabindex="-1">playbook 剧本 <a class="header-anchor" href="#playbook-剧本" aria-label="Permalink to &quot;playbook 剧本&quot;">​</a></h1><p><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html" target="_blank" rel="noreferrer">Ansible Playbooks</a> 提供了一种可重复、可重用、简单的配置管理和多机部署系统，非常适合部署复杂的应用程序。</p><p>剧本由有序列表中的一个或多个&quot;剧本&quot;组成，每个 play 执行 playbook 总体目标的一部分，运行一个或多个任务，每个任务调用一个 Ansible 模块。</p><h2 id="核心元素" tabindex="-1">核心元素 <a class="header-anchor" href="#核心元素" aria-label="Permalink to &quot;核心元素&quot;">​</a></h2><ul><li><strong>Hosts</strong> 执行的远程主机列表</li><li><strong>Tasks</strong> 任务集</li><li><strong>Variables</strong> 内置变量或自定义变量在playbook中调用</li><li><strong>Templates</strong> 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li><li><strong>Handlers</strong> 和 <strong>Notify</strong> 结合使用，由特定条件触发的操作， 满足条件方才执行，否则不执行</li><li><strong>Tags</strong> 指定某条任务执行，用于选择运行 playbook 中的部分代码</li></ul><h3 id="hosts-组件" tabindex="-1">hosts 组件 <a class="header-anchor" href="#hosts-组件" aria-label="Permalink to &quot;hosts 组件&quot;">​</a></h3><p>playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须要先定义在主机清单中。</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">hosts</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">web_servers</span></span></code></pre></div><h3 id="remote-user-组件" tabindex="-1">remote_user 组件 <a class="header-anchor" href="#remote-user-组件" aria-label="Permalink to &quot;remote_user 组件&quot;">​</a></h3><p>可用于 Host 和 Task 中，也可以通过指定使用 sudo 的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user 指定sudo时切换的用户。</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">hosts</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">web_servers</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">remote_user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">tasks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test connection</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">ping</span><span style="color:#89DDFF;">:</span></span></code></pre></div><h3 id="task-列表和-action-组件" tabindex="-1">task 列表和 action 组件 <a class="header-anchor" href="#task-列表和-action-组件" aria-label="Permalink to &quot;task 列表和 action 组件&quot;">​</a></h3><p>playbook 的主体部分就是各种任务列表，任务列表中有一个或多个任务，每个任务按次序逐个在主机清单中匹配的主机上执行。</p><p>任务的目的是使用指定的模块参数执行，而在模块参数中可以使用变量。</p><p>每个任务都应该有对应的名称，用于执行结果的输出。如果没提供名称，则运行结果将用于输出。</p><p><strong>任务格式：</strong></p><ul><li>action: module arguments</li><li>module：arguments （推荐）</li></ul><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">---</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">hosts</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">web_servers</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">remote_user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">tasks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install http server</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">yum</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start http server</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">service</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=nginx state=started enabled=yes</span></span></code></pre></div><h2 id="playbook-命令" tabindex="-1">playbook 命令 <a class="header-anchor" href="#playbook-命令" aria-label="Permalink to &quot;playbook 命令&quot;">​</a></h2><p>格式：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">ansible-playbook</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">filename.ym</span><span style="color:#A6ACCD;">l</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">...</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">options</span><span style="color:#89DDFF;">]</span></span></code></pre></div><p>常见选项</p><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">-C --check      # 仅检测，不执行</span></span>
<span class="line"><span style="color:#A6ACCD;">--list-hosts    # 列出待运行任务的主机</span></span>
<span class="line"><span style="color:#A6ACCD;">--list-tasks    # 列出任务</span></span>
<span class="line"><span style="color:#A6ACCD;">--list-tags     # 列出标签</span></span>
<span class="line"><span style="color:#A6ACCD;">--limit 主机列表 # 只针对主机列表中的指定主机执行任务</span></span>
<span class="line"><span style="color:#A6ACCD;">-v, -vv, -vvv   # 显示过程信息</span></span></code></pre></div><h2 id="一些示例" tabindex="-1">一些示例 <a class="header-anchor" href="#一些示例" aria-label="Permalink to &quot;一些示例&quot;">​</a></h2><h3 id="创建-mysql-用户" tabindex="-1">创建 MySQL 用户 <a class="header-anchor" href="#创建-mysql-用户" aria-label="Permalink to &quot;创建 MySQL 用户&quot;">​</a></h3><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">---</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">hosts</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">db_servers</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">remote_user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">gather_facts</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">tasks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">create group</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">group</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=mysql system=yes gid=306</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">create user</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=mysql shell=/sbin/nologin system=yes group=mysql uid=306 create_home=no</span></span></code></pre></div><h3 id="安装-nginx" tabindex="-1">安装 Nginx <a class="header-anchor" href="#安装-nginx" aria-label="Permalink to &quot;安装 Nginx&quot;">​</a></h3><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">---</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">hosts</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">web_servers</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">remote_user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">gather_facts</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">tasks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add nginx group</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">group</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=nginx state=present</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add nginx user</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=nginx state=present group=nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">yum</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=nginx state=present</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">service</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=nginx state=started enabled=yes</span></span></code></pre></div><h3 id="卸载-nginx" tabindex="-1">卸载 Nginx <a class="header-anchor" href="#卸载-nginx" aria-label="Permalink to &quot;卸载 Nginx&quot;">​</a></h3><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">---</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">hosts</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">web_servers</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">remote_user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">gather_facts</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">tasks</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">uninstall nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">yum</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=nginx state=absent</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">remove nginx user</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">user</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=nginx state=absent</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">remove nginx group</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">group</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=nginx state=absent</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">remove config files</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#F07178;">file</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name=/etc/nginx state=absent</span></span></code></pre></div>`,30),e=[o];function t(r,c,y,C,D,i){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{F as __pageData,d as default};
